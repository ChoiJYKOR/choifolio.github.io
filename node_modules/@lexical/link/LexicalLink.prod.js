/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 */

"use strict";var e=require("@lexical/utils"),t=require("lexical"),n=require("@lexical/extension");const r=new Set(["http:","https:","mailto:","sms:","tel:"]);class i extends t.ElementNode{__url;__target;__rel;__title;static getType(){return"link"}static clone(e){return new i(e.__url,{rel:e.__rel,target:e.__target,title:e.__title},e.__key)}constructor(e="",t={},n){super(n);const{target:r=null,rel:i=null,title:s=null}=t;this.__url=e,this.__target=r,this.__rel=i,this.__title=s}createDOM(t){const n=document.createElement("a");return this.updateLinkDOM(null,n,t),e.addClassNamesToElement(n,t.theme.link),n}updateLinkDOM(t,n,r){if(e.isHTMLAnchorElement(n)){t&&t.__url===this.__url||(n.href=this.sanitizeUrl(this.__url));for(const e of["target","rel","title"]){const r=`__${e}`,i=this[r];t&&t[r]===i||(i?n[e]=i:n.removeAttribute(e))}}}updateDOM(e,t,n){return this.updateLinkDOM(e,t,n),!1}static importDOM(){return{a:e=>({conversion:s,priority:1})}}static importJSON(e){return l().updateFromJSON(e)}updateFromJSON(e){return super.updateFromJSON(e).setURL(e.url).setRel(e.rel||null).setTarget(e.target||null).setTitle(e.title||null)}sanitizeUrl(e){e=p(e);try{const t=new URL(p(e));if(!r.has(t.protocol))return"about:blank"}catch(t){return e}return e}exportJSON(){return{...super.exportJSON(),rel:this.getRel(),target:this.getTarget(),title:this.getTitle(),url:this.getURL()}}getURL(){return this.getLatest().__url}setURL(e){const t=this.getWritable();return t.__url=e,t}getTarget(){return this.getLatest().__target}setTarget(e){const t=this.getWritable();return t.__target=e,t}getRel(){return this.getLatest().__rel}setRel(e){const t=this.getWritable();return t.__rel=e,t}getTitle(){return this.getLatest().__title}setTitle(e){const t=this.getWritable();return t.__title=e,t}insertNewAfter(e,t=!0){const n=l(this.__url,{rel:this.__rel,target:this.__target,title:this.__title});return this.insertAfter(n,t),n}canInsertTextBefore(){return!1}canInsertTextAfter(){return!1}canBeEmpty(){return!1}isInline(){return!0}extractWithChild(e,n,r){if(!t.$isRangeSelection(n))return!1;const i=n.anchor.getNode(),s=n.focus.getNode();return this.isParentOf(i)&&this.isParentOf(s)&&n.getTextContent().length>0}isEmailURI(){return this.__url.startsWith("mailto:")}isWebSiteURI(){return this.__url.startsWith("https://")||this.__url.startsWith("http://")}}function s(t){let n=null;if(e.isHTMLAnchorElement(t)){const e=t.textContent;(null!==e&&""!==e||t.children.length>0)&&(n=l(t.getAttribute("href")||"",{rel:t.getAttribute("rel"),target:t.getAttribute("target"),title:t.getAttribute("title")}))}return{node:n}}function l(e="",n){return t.$applyNodeReplacement(new i(e,n))}function o(e){return e instanceof i}class u extends i{__isUnlinked;constructor(e="",t={},n){super(e,t,n),this.__isUnlinked=void 0!==t.isUnlinked&&null!==t.isUnlinked&&t.isUnlinked}static getType(){return"autolink"}static clone(e){return new u(e.__url,{isUnlinked:e.__isUnlinked,rel:e.__rel,target:e.__target,title:e.__title},e.__key)}getIsUnlinked(){return this.__isUnlinked}setIsUnlinked(e){const t=this.getWritable();return t.__isUnlinked=e,t}createDOM(e){return this.__isUnlinked?document.createElement("span"):super.createDOM(e)}updateDOM(e,t,n){return super.updateDOM(e,t,n)||e.__isUnlinked!==this.__isUnlinked}static importJSON(e){return a().updateFromJSON(e)}updateFromJSON(e){return super.updateFromJSON(e).setIsUnlinked(e.isUnlinked||!1)}static importDOM(){return null}exportJSON(){return{...super.exportJSON(),isUnlinked:this.__isUnlinked}}insertNewAfter(e,n=!0){const r=this.getParentOrThrow().insertNewAfter(e,n);if(t.$isElementNode(r)){const e=a(this.__url,{isUnlinked:this.__isUnlinked,rel:this.__rel,target:this.__target,title:this.__title});return r.append(e),e}return null}}function a(e="",n){return t.$applyNodeReplacement(new u(e,n))}function c(e){return e instanceof u}const g=t.createCommand("TOGGLE_LINK_COMMAND");function d(e,n){if("element"===e.type){const r=e.getNode();t.$isElementNode(r)||function(e,...t){const n=new URL("https://lexical.dev/docs/error"),r=new URLSearchParams;r.append("code",e);for(const e of t)r.append("v",e);throw n.search=r.toString(),Error(`Minified Lexical error #${e}; visit ${n.toString()} for the full message or use the non-minified dev environment for full errors and additional helpful warnings.`)}(252);return r.getChildren()[e.offset+n]||null}return null}function f(n,r={}){let i;if(n&&"object"==typeof n){const{url:e,...t}=n;i=e,r={...t,...r}}else i=n;const{target:s,title:u}=r,a=void 0===r.rel?"noreferrer":r.rel,g=t.$getSelection();if(null===g||!t.$isRangeSelection(g)&&!t.$isNodeSelection(g))return;if(t.$isNodeSelection(g)){const t=g.getNodes();if(0===t.length)return;return void t.forEach(t=>{if(null===i){const n=e.$findMatchingParent(t,e=>!c(e)&&o(e));n&&(n.insertBefore(t),0===n.getChildren().length&&n.remove())}else{const n=e.$findMatchingParent(t,e=>!c(e)&&o(e));if(n)n.setURL(i),void 0!==s&&n.setTarget(s),void 0!==a&&n.setRel(a);else{const e=l(i,{rel:a,target:s});t.insertBefore(e),e.append(t)}}})}const f=g.extract();if(null===i)return void f.forEach(t=>{const n=e.$findMatchingParent(t,e=>!c(e)&&o(e));if(n){const e=n.getChildren();for(let t=0;t<e.length;t++)n.insertBefore(e[t]);n.remove()}});const h=new Set,p=e=>{h.has(e.getKey())||(h.add(e.getKey()),e.setURL(i),void 0!==s&&e.setTarget(s),void 0!==a&&e.setRel(a),void 0!==u&&e.setTitle(u))};if(1===f.length){const t=f[0],n=e.$findMatchingParent(t,o);if(null!==n)return p(n)}!function(e){const n=t.$getSelection();if(!t.$isRangeSelection(n))return e();const r=t.$normalizeSelection__EXPERIMENTAL(n),i=r.isBackward(),s=d(r.anchor,i?-1:0),l=d(r.focus,i?0:-1),o=e();if(s||l){const e=t.$getSelection();if(t.$isRangeSelection(e)){const n=e.clone();if(s){const e=s.getParent();e&&n.anchor.set(e.getKey(),s.getIndexWithinParent()+(i?1:0),"element")}if(l){const e=l.getParent();e&&n.focus.set(e.getKey(),l.getIndexWithinParent()+(i?0:1),"element")}t.$setSelection(t.$normalizeSelection__EXPERIMENTAL(n))}}}(()=>{let n=null;for(const r of f){if(!r.isAttached())continue;const g=e.$findMatchingParent(r,o);if(g){p(g);continue}if(t.$isElementNode(r)){if(!r.isInline())continue;if(o(r)){if(!(c(r)||null!==n&&n.getParentOrThrow().isParentOf(r))){p(r),n=r;continue}for(const e of r.getChildren())r.insertBefore(e);r.remove();continue}}const d=r.getPreviousSibling();o(d)&&d.is(n)?d.append(r):(n=l(i,{rel:a,target:s,title:u}),r.insertAfter(n),n.append(r))}})}const h=/^\+?[0-9\s()-]{5,}$/;function p(e){return e.match(/^[a-z][a-z0-9+.-]*:/i)||e.match(/^[/#.]/)?e:e.includes("@")?`mailto:${e}`:h.test(e)?`tel:${e}`:`https://${e}`}const _={attributes:void 0,validateUrl:void 0};function m(r,i){return e.mergeRegister(n.effect(()=>r.registerCommand(g,e=>{const t=i.validateUrl.peek(),n=i.attributes.peek();if(null===e)return f(null),!0;if("string"==typeof e)return!(void 0!==t&&!t(e))&&(f(e,n),!0);{const{url:t,target:r,rel:i,title:s}=e;return f(t,{...n,rel:i,target:r,title:s}),!0}},t.COMMAND_PRIORITY_LOW)),n.effect(()=>{const n=i.validateUrl.value;if(!n)return;const s=i.attributes.value;return r.registerCommand(t.PASTE_COMMAND,i=>{const l=t.$getSelection();if(!t.$isRangeSelection(l)||l.isCollapsed()||!e.objectKlassEquals(i,ClipboardEvent))return!1;if(null===i.clipboardData)return!1;const o=i.clipboardData.getData("text");return!!n(o)&&(!l.getNodes().some(e=>t.$isElementNode(e))&&(r.dispatchCommand(g,{...s,url:o}),i.preventDefault(),!0))},t.COMMAND_PRIORITY_LOW)}))}const x=t.defineExtension({build:(e,t,r)=>n.namedSignals(t),config:_,name:"@lexical/link/Link",nodes:[i],register:(e,t,n)=>m(e,n.getOutput())});function N(n,r,i={}){const s=i=>{const s=i.target;if(!t.isDOMNode(s))return;const l=t.getNearestEditorFromDOMNode(s);if(null===l)return;let u=null,a=null;if(l.update(()=>{const n=t.$getNearestNodeFromDOMNode(s);if(null!==n){const i=e.$findMatchingParent(n,t.$isElementNode);if(!r.disabled.peek())if(o(i))u=i.sanitizeUrl(i.getURL()),a=i.getTarget();else{const t=function(e,t){let n=e;for(;null!=n;){if(t(n))return n;n=n.parentNode}return null}(s,e.isHTMLAnchorElement);null!==t&&(u=t.href,a=t.target)}}}),null===u||""===u)return;const c=n.getEditorState().read(t.$getSelection);if(t.$isRangeSelection(c)&&!c.isCollapsed())return void i.preventDefault();const g="auxclick"===i.type&&1===i.button;window.open(u,r.newTab.peek()||g||i.metaKey||i.ctrlKey||"_blank"===a?"_blank":"_self"),i.preventDefault()},l=e=>{1===e.button&&s(e)};return n.registerRootListener((e,t)=>{null!==t&&(t.removeEventListener("click",s),t.removeEventListener("mouseup",l)),null!==e&&(e.addEventListener("click",s,i),e.addEventListener("mouseup",l,i))})}const k=t.defineExtension({build:(e,t,r)=>n.namedSignals(t),config:t.safeCast({disabled:!1,newTab:!1}),dependencies:[x],name:"@lexical/link/ClickableLink",register:(e,t,n)=>N(e,n.getOutput())});function L(e,t){for(let n=0;n<t.length;n++){const r=t[n](e);if(r)return r}return null}const T=/[.,;\s]/;function S(e){return T.test(e)}function $(e){return S(e[e.length-1])}function U(e){return S(e[0])}function b(e){let n=e.getPreviousSibling();return t.$isElementNode(n)&&(n=n.getLastDescendant()),null===n||t.$isLineBreakNode(n)||t.$isTextNode(n)&&$(n.getTextContent())}function R(e){let n=e.getNextSibling();return t.$isElementNode(n)&&(n=n.getFirstDescendant()),null===n||t.$isLineBreakNode(n)||t.$isTextNode(n)&&U(n.getTextContent())}function v(e,t,n,r){if(!(e>0?S(n[e-1]):b(r[0])))return!1;return t<n.length?S(n[t]):R(r[r.length-1])}function O(e,t,n){const r=[],i=[],s=[];let l=0,o=0;const u=[...e];for(;u.length>0;){const e=u[0],a=e.getTextContent().length,c=o;o+a<=t?(r.push(e),l+=a):c>=n?s.push(e):i.push(e),o+=a,u.shift()}return[l,r,i,s]}function E(e,n,r,i){const s=a(i.url,i.attributes);if(1===e.length){let l,o=e[0];0===n?[l,o]=o.splitText(r):[,l,o]=o.splitText(n,r);const u=t.$createTextNode(i.text);return u.setFormat(l.getFormat()),u.setDetail(l.getDetail()),u.setStyle(l.getStyle()),s.append(u),l.replace(s),o}if(e.length>1){const i=e[0];let l,o=i.getTextContent().length;0===n?l=i:[,l]=i.splitText(n);const u=[];let a;for(let t=1;t<e.length;t++){const n=e[t],i=n.getTextContent().length,s=o;if(s<r)if(o+i<=r)u.push(n);else{const[e,t]=n.splitText(r-s);u.push(e),a=t}o+=i}const c=t.$getSelection(),g=c?c.getNodes().find(t.$isTextNode):void 0,d=t.$createTextNode(l.getTextContent());return d.setFormat(l.getFormat()),d.setDetail(l.getDetail()),d.setStyle(l.getStyle()),s.append(d,...u),g&&g===l&&(t.$isRangeSelection(c)?d.select(c.anchor.offset,c.focus.offset):t.$isNodeSelection(c)&&d.select(0,d.getTextContent().length)),l.replace(s),a}}function C(e,n,r){const i=e.getChildren(),s=i.length;for(let n=0;n<s;n++){const s=i[n];if(!t.$isTextNode(s)||!s.isSimpleText())return M(e),void r(null,e.getURL())}const l=e.getTextContent(),o=L(l,n);if(null===o||o.text!==l)return M(e),void r(null,e.getURL());if(!b(e)||!R(e))return M(e),void r(null,e.getURL());const u=e.getURL();if(u!==o.url&&(e.setURL(o.url),r(o.url,u)),o.attributes){const t=e.getRel();t!==o.attributes.rel&&(e.setRel(o.attributes.rel||null),r(o.attributes.rel||null,t));const n=e.getTarget();n!==o.attributes.target&&(e.setTarget(o.attributes.target||null),r(o.attributes.target||null,n))}}function M(e){const t=e.getChildren();for(let n=t.length-1;n>=0;n--)e.insertAfter(t[n]);return e.remove(),t.map(e=>e.getLatest())}const A={changeHandlers:[],matchers:[]};function D(n,r=A){const{matchers:i,changeHandlers:s}=r,l=(e,t)=>{for(const n of s)n(e,t)};return e.mergeRegister(n.registerNodeTransform(t.TextNode,e=>{const n=e.getParentOrThrow(),r=e.getPreviousSibling();if(c(n)&&!n.getIsUnlinked())C(n,i,l);else if(!o(n)){if(e.isSimpleText()&&(U(e.getTextContent())||!c(r))){const n=function(e){const n=[e];let r=e.getNextSibling();for(;null!==r&&t.$isTextNode(r)&&r.isSimpleText()&&(n.push(r),!/[\s]/.test(r.getTextContent()));)r=r.getNextSibling();return n}(e);!function(e,t,n){let r=[...e];const i=r.map(e=>e.getTextContent()).join("");let s,l=i,o=0;for(;(s=L(l,t))&&null!==s;){const e=s.index,t=e+s.length;if(v(o+e,o+t,i,r)){const[i,,l,u]=O(r,o+e,o+t),a=E(l,o+e-i,o+t-i,s);r=a?[a,...u]:u,n(s.url,null),o=0}else o+=t;l=l.substring(t)}}(n,i,l)}!function(e,t,n){const r=e.getPreviousSibling(),i=e.getNextSibling(),s=e.getTextContent();var l;!c(r)||r.getIsUnlinked()||U(s)&&(l=s,!(r.isEmailURI()?/^\.[a-zA-Z]{2,}/.test(l):/^\.[a-zA-Z0-9]{1,}/.test(l)))||(r.append(e),C(r,t,n),n(null,r.getURL())),!c(i)||i.getIsUnlinked()||$(s)||(M(i),C(i,t,n),n(null,i.getURL()))}(e,i,l)}}),n.registerCommand(g,e=>{const n=t.$getSelection();if(null!==e||!t.$isRangeSelection(n))return!1;return n.extract().forEach(e=>{const t=e.getParent();c(t)&&(t.setIsUnlinked(!t.getIsUnlinked()),t.markDirty())}),!1},t.COMMAND_PRIORITY_LOW))}const P=t.defineExtension({config:A,dependencies:[x],mergeConfig(e,n){const r=t.shallowMergeConfig(e,n);for(const t of["matchers","changeHandlers"]){const i=n[t];Array.isArray(i)&&(r[t]=[...e[t],...i])}return r},name:"@lexical/link/AutoLink",register:D}),I=f;exports.$createAutoLinkNode=a,exports.$createLinkNode=l,exports.$isAutoLinkNode=c,exports.$isLinkNode=o,exports.$toggleLink=f,exports.AutoLinkExtension=P,exports.AutoLinkNode=u,exports.ClickableLinkExtension=k,exports.LinkExtension=x,exports.LinkNode=i,exports.TOGGLE_LINK_COMMAND=g,exports.createLinkMatcherWithRegExp=function(e,t=e=>e){return n=>{const r=e.exec(n);return null===r?null:{index:r.index,length:r[0].length,text:r[0],url:t(r[0])}}},exports.formatUrl=p,exports.registerAutoLink=D,exports.registerClickableLink=N,exports.registerLink=m,exports.toggleLink=I;
