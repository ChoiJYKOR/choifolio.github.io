/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 */

"use strict";var e=require("lexical"),t=require("yjs"),n=require("@lexical/offset"),o=require("@lexical/selection");function s(e,...t){const n=new URL("https://lexical.dev/docs/error"),o=new URLSearchParams;o.append("code",e);for(const e of t)o.append("v",e);throw n.search=o.toString(),Error(`Minified Lexical error #${e}; visit ${n.toString()} for the full message or use the non-minified dev environment for full errors and additional helpful warnings.`)}function i(e,t,n){const o=e.length,s=t.length;let i=0,r=0;for(;i<o&&i<s&&e[i]===t[i]&&i<n;)i++;for(;r+i<o&&r+i<s&&e[o-r-1]===t[s-r-1];)r++;for(;r+i<o&&r+i<s&&e[i]===t[i];)i++;return{index:i,insert:t.slice(i,s-r),remove:o-i-r}}class r{_xmlElem;_key;_parent;_type;constructor(e,t,n){this._key="",this._xmlElem=e,this._parent=t,this._type=n}getPrevNode(t){if(null===t)return null;const n=t.get(this._key);return e.$isDecoratorNode(n)?n:null}getNode(){const t=e.$getNodeByKey(this._key);return e.$isDecoratorNode(t)?t:null}getSharedType(){return this._xmlElem}getType(){return this._type}getKey(){return this._key}getSize(){return 1}getOffset(){return this._parent.getChildOffset(this)}syncPropertiesFromLexical(e,t,n){const o=this.getPrevNode(n);w(e,this._xmlElem,o,t)}syncPropertiesFromYjs(e,t){const n=this.getNode();null===n&&s(83);$(e,this._xmlElem,n,t)}destroy(e){const t=e.collabNodeMap;t.get(this._key)===this&&t.delete(this._key)}}function l(e,t,n){const o=new r(e,t,n);return e._collabNode=o,o}class c{_map;_key;_parent;_type;constructor(e,t){this._key="",this._map=e,this._parent=t,this._type="linebreak"}getNode(){const t=e.$getNodeByKey(this._key);return e.$isLineBreakNode(t)?t:null}getKey(){return this._key}getSharedType(){return this._map}getType(){return this._type}getSize(){return 1}getOffset(){return this._parent.getChildOffset(this)}destroy(e){const t=e.collabNodeMap;t.get(this._key)===this&&t.delete(this._key)}}function a(e,t){const n=new c(e,t);return e._collabNode=n,n}class f{_map;_key;_parent;_text;_type;_normalized;constructor(e,t,n,o){this._key="",this._map=e,this._parent=n,this._text=t,this._type=o,this._normalized=!1}getPrevNode(t){if(null===t)return null;const n=t.get(this._key);return e.$isTextNode(n)?n:null}getNode(){const t=e.$getNodeByKey(this._key);return e.$isTextNode(t)?t:null}getSharedType(){return this._map}getType(){return this._type}getKey(){return this._key}getSize(){return this._text.length+(this._normalized?0:1)}getOffset(){return this._parent.getChildOffset(this)}spliceText(e,t,n){const o=this._parent._xmlText,s=this.getOffset()+1+e;0!==t&&o.delete(s,t),""!==n&&o.insert(s,n)}syncPropertiesAndTextFromLexical(t,n,o){const s=this.getPrevNode(o),r=n.__text;if(w(t,this._map,s,n),null!==s){const t=s.__text;if(t!==r){!function(t,n,o,s){const r=e.$getSelection();let l=s.length;if(e.$isRangeSelection(r)&&r.isCollapsed()){const e=r.anchor;e.key===n&&(l=e.offset)}const c=i(o,s,l);t.spliceText(c.index,c.remove,c.insert)}(this,n.__key,t,r),this._text=r}}}syncPropertiesAndTextFromYjs(e,t){const n=this.getNode();null===n&&s(84),$(e,this._map,n,t);const o=this._text;n.__text!==o&&n.setTextContent(o)}destroy(e){const t=e.collabNodeMap;t.get(this._key)===this&&t.delete(this._key)}}function d(e,t,n,o){const s=new f(e,t,n,o);return e._collabNode=s,s}class u{_key;_children;_xmlText;_type;_parent;constructor(e,t,n){this._key="",this._children=[],this._xmlText=e,this._type=n,this._parent=t}getPrevNode(t){if(null===t)return null;const n=t.get(this._key);return e.$isElementNode(n)?n:null}getNode(){const t=e.$getNodeByKey(this._key);return e.$isElementNode(t)?t:null}getSharedType(){return this._xmlText}getType(){return this._type}getKey(){return this._key}isEmpty(){return 0===this._children.length}getSize(){return 1}getOffset(){const e=this._parent;return null===e&&s(90),e.getChildOffset(this)}syncPropertiesFromYjs(e,t){const n=this.getNode();null===n&&s(91),$(e,this._xmlText,n,t)}applyChildrenYjsDelta(e,t){const n=this._children;let o=0,s=null;for(let i=0;i<t.length;i++){const l=t[i],a=l.insert,d=l.delete;if(null!=l.retain)o+=l.retain;else if("number"==typeof d){let e=d;for(;e>0;){const{node:t,nodeIndex:s,offset:i,length:l}=K(this,o,!1);if(t instanceof u||t instanceof c||t instanceof r)n.splice(s,1),e-=1;else{if(!(t instanceof f))break;{const o=Math.min(e,l),r=0!==s?n[s-1]:null,c=t.getSize();if(0===i&&l===c){n.splice(s,1);const e=M(t._text,i,o-1,"");e.length>0&&(r instanceof f?r._text+=e:this._xmlText.delete(i,e.length))}else t._text=M(t._text,i,o,"");e-=o}}}}else{if(null==a)throw new Error("Unexpected delta format");if("string"==typeof a){const{node:e,offset:t}=K(this,o,!0);e instanceof f?e._text=M(e._text,t,0,a):this._xmlText.delete(t,a.length),o+=a.length}else{const t=a,{node:i,nodeIndex:r,length:l}=K(this,o,!1),c=C(e,t,this);if(i instanceof f&&l>0&&l<i._text.length){const e=i._text,t=e.length-l;i._text=M(e,t,l,""),n.splice(r+1,0,c),s=M(e,0,t,"")}else n.splice(r,0,c);null!==s&&c instanceof f&&(c._text=s+c._text,s=null),o+=1}}}}syncChildrenFromYjs(t){const o=this.getNode();null===o&&s(92);const i=o.__key,l=n.$createChildrenArray(o,null),a=l.length,d=this._children,h=d.length,p=t.collabNodeMap,g=new Set;let _,y,m=0,x=null;h!==a&&(y=o.getWritable());for(let n=0;n<h;n++){const a=l[m],T=d[n],N=T.getNode(),S=T._key;if(null!==N&&a===S){const n=e.$isTextNode(N);if(g.add(a),n)if(T._key=a,T instanceof u){const e=T._xmlText;T.syncPropertiesFromYjs(t,null),T.applyChildrenYjsDelta(t,e.toDelta()),T.syncChildrenFromYjs(t)}else T instanceof f?T.syncPropertiesAndTextFromYjs(t,null):T instanceof r?T.syncPropertiesFromYjs(t,null):T instanceof c||s(93);x=N,m++}else{if(void 0===_){_=new Set;for(let e=0;e<h;e++){const t=d[e]._key;""!==t&&_.add(t)}}if(null!==N&&void 0!==a&&!_.has(a)){const t=e.$getNodeByKeyOrThrow(a);e.removeFromParent(t),n--,m++;continue}y=o.getWritable();const s=k(t,T,i),r=s.__key;if(p.set(r,T),null===x){const e=y.getFirstChild();if(y.__first=r,null!==e){const t=e.getWritable();t.__prev=r,s.__next=t.__key}}else{const e=x.getWritable(),t=x.getNextSibling();if(e.__next=r,s.__prev=x.__key,null!==t){const e=t.getWritable();e.__prev=r,s.__next=e.__key}}n===h-1&&(y.__last=r),y.__size++,x=s}}for(let n=0;n<a;n++){const o=l[n];if(!g.has(o)){const n=e.$getNodeByKeyOrThrow(o),s=t.collabNodeMap.get(o);void 0!==s&&s.destroy(t),e.removeFromParent(n)}}}syncPropertiesFromLexical(e,t,n){w(e,this._xmlText,this.getPrevNode(n),t)}_syncChildFromLexical(t,n,o,s,i,l){const c=this._children[n],a=e.$getNodeByKeyOrThrow(o);c instanceof u&&e.$isElementNode(a)?(c.syncPropertiesFromLexical(t,a,s),c.syncChildrenFromLexical(t,a,s,i,l)):c instanceof f&&e.$isTextNode(a)?c.syncPropertiesAndTextFromLexical(t,a,s):c instanceof r&&e.$isDecoratorNode(a)&&c.syncPropertiesFromLexical(t,a,s)}syncChildrenFromLexical(t,o,s,i,r){const l=this.getPrevNode(s),c=null===l?[]:n.$createChildrenArray(l,s),a=n.$createChildrenArray(o,null),f=c.length-1,d=a.length-1,u=t.collabNodeMap;let h,p,g=0,_=0;for(;g<=f&&_<=d;){const n=c[g],o=a[_];if(n===o)this._syncChildFromLexical(t,_,o,s,i,r),g++,_++;else{void 0===h&&(h=new Set(c)),void 0===p&&(p=new Set(a));const s=p.has(n),i=h.has(o);if(s){const n=E(t,e.$getNodeByKeyOrThrow(o),this);u.set(o,n),i?(this.splice(t,_,1,n),g++,_++):(this.splice(t,_,0,n),_++)}else this.splice(t,_,1),g++}}const y=g>f,m=_>d;if(y&&!m)for(;_<=d;++_){const n=a[_],o=E(t,e.$getNodeByKeyOrThrow(n),this);this.append(o),u.set(n,o)}else if(m&&!y)for(let e=this._children.length-1;e>=_;e--)this.splice(t,e,1)}append(e){const t=this._xmlText,n=this._children,o=n[n.length-1],s=void 0!==o?o.getOffset()+o.getSize():0;if(e instanceof u)t.insertEmbed(s,e._xmlText);else if(e instanceof f){const n=e._map;null===n.parent&&t.insertEmbed(s,n),t.insert(s+1,e._text)}else e instanceof c?t.insertEmbed(s,e._map):e instanceof r&&t.insertEmbed(s,e._xmlElem);this._children.push(e)}splice(e,t,n,o){const i=this._children,l=i[t];if(void 0===l)return void 0===o&&s(94),void this.append(o);const a=l.getOffset();-1===a&&s(95);const d=this._xmlText;if(0!==n&&d.delete(a,l.getSize()),o instanceof u)d.insertEmbed(a,o._xmlText);else if(o instanceof f){const e=o._map;null===e.parent&&d.insertEmbed(a,e),d.insert(a+1,o._text)}else o instanceof c?d.insertEmbed(a,o._map):o instanceof r&&d.insertEmbed(a,o._xmlElem);if(0!==n){const o=i.slice(t,t+n);for(let t=0;t<o.length;t++)o[t].destroy(e)}void 0!==o?i.splice(t,n,o):i.splice(t,n)}getChildOffset(e){let t=0;const n=this._children;for(let o=0;o<n.length;o++){const s=n[o];if(s===e)return t;t+=s.getSize()}return-1}destroy(e){const t=e.collabNodeMap,n=this._children;for(let t=0;t<n.length;t++)n[t].destroy(e);t.get(this._key)===this&&t.delete(this._key)}}function h(e,t,n){const o=new u(e,t,n);return e._collabNode=o,o}class p{_nodeMap=new Map;_sharedTypeToNodeKeys=new Map;_nodeKeyToSharedType=new Map;set(n,o){const i=o instanceof Array;this.delete(n);const r=i?o:[o];for(const e of r){const t=e.getKey();if(this._nodeKeyToSharedType.has(t)){const e=this._nodeKeyToSharedType.get(t),n=this._sharedTypeToNodeKeys.get(e).indexOf(t);-1!==n&&this._sharedTypeToNodeKeys.get(e).splice(n,1),this._nodeKeyToSharedType.delete(t),this._nodeMap.delete(t)}}if(n instanceof t.XmlText){if(i||s(331),0===o.length)return;this._sharedTypeToNodeKeys.set(n,o.map(e=>e.getKey()));for(const e of o)this._nodeMap.set(e.getKey(),e),this._nodeKeyToSharedType.set(e.getKey(),n)}else i&&s(332),e.$isTextNode(o)&&s(333),this._sharedTypeToNodeKeys.set(n,[o.getKey()]),this._nodeMap.set(o.getKey(),o),this._nodeKeyToSharedType.set(o.getKey(),n)}get(e){const n=this._sharedTypeToNodeKeys.get(e);if(void 0!==n){if(e instanceof t.XmlText){const e=Array.from(n.map(e=>this._nodeMap.get(e)));return e.length>0?e:void 0}return this._nodeMap.get(n[0])}}getSharedType(e){return this._nodeKeyToSharedType.get(e.getKey())}delete(e){const t=this._sharedTypeToNodeKeys.get(e);if(void 0!==t){for(const e of t)this._nodeMap.delete(e),this._nodeKeyToSharedType.delete(e);this._sharedTypeToNodeKeys.delete(e)}}deleteNode(e){const t=this._nodeKeyToSharedType.get(e);t&&this.delete(t),this._nodeMap.delete(e)}has(e){return this._sharedTypeToNodeKeys.has(e)}clear(){this._nodeMap.clear(),this._sharedTypeToNodeKeys.clear(),this._nodeKeyToSharedType.clear()}}function g(e,t,n,o,i){null==n&&s(81);const r={clientID:n.clientID,cursors:new Map,cursorsContainer:null,doc:n,docMap:o,editor:e,excludedProperties:i||new Map,id:t,nodeProperties:new Map};return function(e){const{editor:t,nodeProperties:n}=e;t.update(()=>{t._nodes.forEach(t=>{const o=new t.klass,s={};for(const[t,n]of Object.entries(o))N(t,o,e)||(s[t]=n);n.set(o.__type,Object.freeze(s))})})}(r),r}function _(e){return Object.hasOwn(e,"collabNodeMap")}const y=new Set(["__key","__parent","__next","__prev","__state"]),m=new Set(["__first","__last","__size"]),x=new Set(["__cachedText"]),T=new Set(["__text"]);function N(t,n,o){if(y.has(t)||"function"==typeof n[t])return!0;if(e.$isTextNode(n)){if(T.has(t))return!0}else if(e.$isElementNode(n)&&(m.has(t)||e.$isRootNode(n)&&x.has(t)))return!0;const s=n.constructor,i=o.excludedProperties.get(s);return null!=i&&i.has(t)}function S(e,t){const n=e.__type,{nodeProperties:o}=t,i=o.get(n);return void 0===i&&s(330,n),i}function E(n,o,i){const r=o.__type;let c;if(e.$isElementNode(o)){c=h(new t.XmlText,i,r),c.syncPropertiesFromLexical(n,o,null),c.syncChildrenFromLexical(n,o,null,null,null)}else if(e.$isTextNode(o)){c=d(new t.Map,o.__text,i,r),c.syncPropertiesAndTextFromLexical(n,o,null)}else if(e.$isLineBreakNode(o)){const e=new t.Map;e.set("__type","linebreak"),c=a(e,i)}else if(e.$isDecoratorNode(o)){c=l(new t.XmlElement,i,r),c.syncPropertiesFromLexical(n,o,null)}else s(86);return c._key=o.__key,c}function b(e){const t=O(e,"__type");return"string"!=typeof t&&void 0!==t&&s(87),t}function C(e,n,o){const i=n._collabNode;if(void 0===i){const i=e.editor._nodes,r=b(n);"string"!=typeof r&&s(87);void 0===i.get(r)&&s(88,r);const c=n.parent,f=void 0===o&&null!==c?C(e,c):o||null;if(f instanceof u||s(89),n instanceof t.XmlText)return h(n,f,r);if(n instanceof t.Map)return"linebreak"===r?a(n,f):d(n,"",f,r);if(n instanceof t.XmlElement)return l(n,f,r)}return i}function k(e,t,n){const o=t.getType(),i=e.editor._nodes.get(o);void 0===i&&s(88,o);const l=new i.klass;if(l.__parent=n,t._key=l.__key,t instanceof u){const n=t._xmlText;t.syncPropertiesFromYjs(e,null),t.applyChildrenYjsDelta(e,n.toDelta()),t.syncChildrenFromYjs(e)}else t instanceof f?t.syncPropertiesAndTextFromYjs(e,null):t instanceof r&&t.syncPropertiesFromYjs(e,null);return e.collabNodeMap.set(l.__key,t),l}function $(n,o,s,i){const r=null===i?o instanceof t.Map?Array.from(o.keys()):o instanceof t.XmlText||o instanceof t.XmlElement?Object.keys(o.getAttributes()):Object.keys(o):Array.from(i);let l;for(let i=0;i<r.length;i++){const c=r[i];if(N(c,s,n)){"__state"===c&&_(n)&&(l||(l=s.getWritable()),A(o,l));continue}const a=s[c];let f=O(o,c);if(a!==f){if(f instanceof t.Doc){const o=n.docMap;a instanceof t.Doc&&o.delete(a.guid);const s=e.createEditor(),i=f.guid;s._key=i,o.set(i,f),f=s}void 0===l&&(l=s.getWritable()),l[c]=f}}}function O(e,n){return e instanceof t.Map?e.get(n):e instanceof t.XmlText||e instanceof t.XmlElement?e.getAttribute(n):e[n]}function v(e,n,o){e instanceof t.Map?e.set(n,o):e.setAttribute(n,o)}function A(n,o){const s=O(n,"__state");s instanceof t.Map&&e.$getWritableNodeState(o).updateFromJSON(s.toJSON())}function w(e,n,o,s){const i=Object.keys(S(s,e)),r=e.editor.constructor;!function(e,n,o,s){const i=s.__state,r=O(n,"__state");if(!i)return;const[l,c]=i.getInternalState(),a=o&&o.__state,f=r instanceof t.Map?r:new t.Map;if(a===i)return;const[d,u]=a&&f.doc?a.getInternalState():[void 0,new Map];if(l)for(const[e,t]of Object.entries(l))d&&t!==d[e]&&f.set(e,t);for(const[e,t]of c)u.get(e)!==t&&f.set(e.key,e.unparse(t));r||v(n,"__state",f)}(0,n,o,s);for(let l=0;l<i.length;l++){const c=i[l],a=null===o?void 0:o[c];let f=s[c];if(a!==f){if(f instanceof r){const n=e.docMap;let o;if(a instanceof r){const e=a._key;o=n.get(e),n.delete(e)}const i=o||new t.Doc,l=i.guid;f._key=l,n.set(l,i),f=i,e.editor.update(()=>{s.markDirty()})}v(n,c,f)}}}function M(e,t,n,o){return e.slice(0,t)+o+e.slice(t+n)}function K(e,t,n){let o=0,s=0;const i=e._children,r=i.length;for(;s<r;s++){const e=i[s],l=o;o+=e.getSize();if((n?o>=t:o>t)&&e instanceof f){let n=t-l-1;n<0&&(n=0);return{length:o-t,node:e,nodeIndex:s,offset:n}}if(o>t)return{length:0,node:e,nodeIndex:s,offset:l};if(s===r-1)return{length:0,node:null,nodeIndex:s+1,offset:l+1}}return{length:0,node:null,nodeIndex:0,offset:0}}function P(t){const n=t.anchor,o=t.focus;let s=!1;try{const t=n.getNode(),i=o.getNode();(!t.isAttached()||!i.isAttached()||e.$isTextNode(t)&&n.offset>t.getTextContentSize()||e.$isTextNode(i)&&o.offset>i.getTextContentSize())&&(s=!0)}catch(e){s=!0}return s}function L(e,t){e.doc.transact(t,e)}function F(t,n){const o=n._nodeMap.get(t);if(!o)return void e.$getRoot().selectStart();const s=o.__prev;let i=null;s&&(i=e.$getNodeByKey(s)),null===i&&null!==o.__parent&&(i=e.$getNodeByKey(o.__parent)),null!==i?null!==i&&i.isAttached()?i.selectEnd():F(i.__key,n):e.$getRoot().selectStart()}const I=e=>"UNDEFINED"===e.nodeName,R=(n,o,i,r,l,c,a)=>{let f=o.mapping.get(n);if(f&&i&&0===i.size&&!r)return f;const d=I(n)?e.RootNode.getType():n.nodeName,u=o.editor._nodes.get(d);if(void 0===u)throw new Error(`$createOrUpdateNodeFromYElement: Node ${d} is not registered`);if(f||(f=new u.klass,i=null,r=!0),r&&f instanceof e.ElementNode){const e=[],i=n=>{if(n instanceof t.XmlElement){const t=R(n,o,new Set,!1,l,c,a);null!==t&&e.push(t)}else if(n instanceof t.XmlText){const t=X(n,o,l,c,a);null!==t&&t.forEach(t=>{null!==t&&e.push(t)})}else s(329)};void 0===l||void 0===c?n.toArray().forEach(i):t.typeListToArraySnapshot(n,new t.Snapshot(c.ds,l.sv)).forEach(i),j(f,e)}const h=n.getAttributes(l);I(n)||void 0===l||(D(n._item,l)?D(n._item,c)||(h[ee("ychange")]=a?a("added",n._item.id):{type:"added"}):h[ee("ychange")]=a?a("removed",n._item.id):{type:"removed"});const p={...S(f,o)},g={};for(const e in h)e.startsWith(Z)?g[te(e)]=h[e]:p[e]=h[e];if($(o,p,f,i),i){const t=Object.keys(g).filter(e=>i.has(ee(e)));if(t.length>0){const n=e.$getWritableNodeState(f);for(const e of t)n.updateFromUnknown(e,g[e])}}else e.$getWritableNodeState(f).updateFromJSON(g);const _=f.getLatest();return o.mapping.set(n,_),_},j=(e,t)=>{const n=e.getChildren(),o=new Set(n.map(e=>e.getKey())),s=new Set(t.map(e=>e.getKey())),i=n.length-1,r=t.length-1;let l=0,c=0;for(;l<=i&&c<=r;){const i=n[l].getKey(),r=t[c].getKey();if(i===r){l++,c++;continue}const a=s.has(i),f=o.has(r);if(!a){if(0===c&&1===e.getChildrenSize())return void e.splice(c,1,t.slice(c));e.splice(c,1,[]),l++;continue}const d=t[c];f?(e.splice(c,1,[d]),l++,c++):(e.splice(c,0,[d]),c++)}const a=l>i,f=c>r;a&&!f?e.append(...t.slice(c)):f&&!a&&e.splice(t.length,e.getChildrenSize()-t.length,[])},D=(e,n)=>void 0===n?!e.deleted:n.sv.has(e.id.client)&&n.sv.get(e.id.client)>e.id.clock&&!t.isDeleted(n.ds,e.id),X=(t,n,o,s,i)=>{const r=J(t,o,s,i);let l=n.mapping.get(t)??[];const c=r.map(t=>t.attributes.t??e.TextNode.getType());if(!(l.length===c.length&&l.every((e,t)=>e.getType()===c[t]))){const t=n.editor._nodes;l=c.map(n=>{const o=t.get(n);if(void 0===o)throw new Error(`$createTextNodesFromYText: Node ${n} is not registered`);const s=new o.klass;if(!e.$isTextNode(s))throw new Error(`$createTextNodesFromYText: Node ${n} is not a TextNode`);return s})}for(let t=0;t<r.length;t++){const o=l[t],s=r[t],{attributes:i,insert:c}=s;o.__text!==c&&o.setTextContent(c);const a={...S(o,n),...i.p},f=Object.fromEntries(Object.entries(i).filter(([e])=>e.startsWith(Z)).map(([e,t])=>[te(e),t]));$(n,a,o,null),e.$getWritableNodeState(o).updateFromJSON(f)}const a=l.map(e=>e.getLatest());return n.mapping.set(t,a),a},z=(n,o)=>n instanceof Array?((e,n)=>{const o=new t.XmlText;return H(o,e,n),o})(n,o):((n,o)=>{const s=new t.XmlElement(n.getType()),i={...Q(n,o),...ne(n)};for(const e in i){const t=i[e];null!==t&&s.setAttribute(e,t)}return n instanceof e.ElementNode?(s.insert(0,U(n).map(e=>z(e,o))),o.mapping.set(s,n),s):s})(n,o),Y=e=>"object"==typeof e&&null!=e,B=(e,t)=>{const n=Object.keys(e).filter(t=>null!==e[t]);if(null==t)return 0===n.length;let o=n.length===Object.keys(t).filter(e=>null!==t[e]).length;for(let s=0;s<n.length&&o;s++){const i=n[s],r=e[i],l=t[i];o="ychange"===i||r===l||Y(r)&&Y(l)&&B(r,l)}return o},U=t=>{if(!(t instanceof e.ElementNode))return[];const n=t.getChildren(),o=[];for(let t=0;t<n.length;t++){const s=n[t];if(e.$isTextNode(s)){const s=[];for(let o=n[t];t<n.length&&e.$isTextNode(o);o=n[++t])s.push(o);t--,o.push(s)}else o.push(s)}return o},W=(t,n,o)=>{const s=J(t);return s.length===n.length&&s.every((t,s)=>{const i=n[s],r=t.attributes.t??e.TextNode.getType(),l=t.attributes.p??{},c=Object.fromEntries(Object.entries(t.attributes).filter(([e])=>e.startsWith(Z)));return t.insert===i.getTextContent()&&r===i.getType()&&B(l,Q(i,o))&&B(c,ne(i))})},G=(e,n,o)=>{if(e instanceof t.XmlElement&&!(n instanceof Array)&&se(e,n)){const t=U(n);return e._length===t.length&&B(e.getAttributes(),{...Q(n,o),...ne(n)})&&e.toArray().every((e,n)=>G(e,t[n],o))}return e instanceof t.XmlText&&n instanceof Array&&W(e,n,o)},V=(e,t)=>e===t||e instanceof Array&&t instanceof Array&&e.length===t.length&&e.every((e,n)=>t[n]===e),q=(e,n,o)=>{const s=e.toArray(),i=U(n),r=i.length,l=s.length,c=Math.min(l,r);let a=0,f=0,d=!1;for(;a<c;a++){const e=s[a],n=i[a];if(e instanceof t.XmlHook)break;if(V(o.mapping.get(e),n))d=!0;else if(!G(e,n,o))break}for(;a+f<c;f++){const e=s[l-f-1],n=i[r-f-1];if(e instanceof t.XmlHook)break;if(V(o.mapping.get(e),n))d=!0;else if(!G(e,n,o))break}return{equalityFactor:a+f,foundMappedChild:d}},H=(n,o,s)=>{s.mapping.set(n,o);const{nAttrs:r,str:l}=(e=>{let n="",o=e._start;const s={};for(;null!==o;)o.deleted||(o.countable&&o.content instanceof t.ContentString?n+=o.content.str:o.content instanceof t.ContentFormat&&(s[o.content.key]=null)),o=o.right;return{nAttrs:s,str:n}})(n),c=o.map((t,n)=>{const o=t.getType();let i=Q(t,s);return 0===Object.keys(i).length&&(i=null),{attributes:Object.assign({},r,{...o!==e.TextNode.getType()&&{t:o},p:i,...ne(t),...n>0&&{i:n}}),insert:t.getTextContent(),nodeKey:t.getKey()}}),a=c.map(e=>e.insert).join(""),f=e.$getSelection();let d;if(e.$isRangeSelection(f)&&f.isCollapsed()){d=0;for(const e of c){if(e.nodeKey===f.anchor.key){d+=f.anchor.offset;break}d+=e.insert.length}}else d=a.length;const{insert:u,remove:h,index:p}=i(l,a,d);n.delete(p,h),n.insert(p,u),n.applyDelta(c.map(e=>({attributes:e.attributes,retain:e.insert.length})))},J=(e,t,n,o)=>e.toDelta(t,n,o).map(e=>{const t=e.attributes??{};return"ychange"in t&&(t[ee("ychange")]=t.ychange,delete t.ychange),{...e,attributes:t}}),Q=(e,t)=>{const n=S(e,t),o={};return Object.entries(n).forEach(([t,n])=>{const s=e[t];s!==n&&(o[t]=s)}),o},Z="s_",ee=e=>`s_${e}`,te=e=>{if(!e.startsWith(Z))throw new Error(`Invalid state key: ${e}`);return e.slice(Z.length)},ne=e=>{const t=e.__state;if(!t)return{};const[n={},o]=t.getInternalState(),s={};for(const[e,t]of Object.entries(n))s[ee(e)]=t;for(const[e,t]of o)s[ee(e.key)]=e.unparse(t);return s},oe=(n,o,s,i,r)=>{if(o instanceof t.XmlElement&&o.nodeName!==s.getType()&&(!I(o)||s.getType()!==e.RootNode.getType()))throw new Error("node name mismatch!");if(i.mapping.set(o,s),o instanceof t.XmlElement){const e=o.getAttributes(),t={...Q(s,i),...ne(s)};for(const n in t)null!=t[n]?e[n]!==t[n]&&"ychange"!==n&&o.setAttribute(n,t[n]):o.removeAttribute(n);for(const n in e)void 0===t[n]&&o.removeAttribute(n)}const l=U(s),c=l.length,a=o.toArray(),f=a.length,d=Math.min(c,f);let u=0,h=0;for(;u<d;u++){const o=a[u],s=l[u];if(o instanceof t.XmlHook)break;if(V(i.mapping.get(o),s))s instanceof e.ElementNode&&r.has(s.getKey())&&oe(n,o,s,i,r);else{if(!G(o,s,i))break;i.mapping.set(o,s)}}for(;h+u<d;h++){const o=a[f-h-1],s=l[c-h-1];if(o instanceof t.XmlHook)break;if(V(i.mapping.get(o),s))s instanceof e.ElementNode&&r.has(s.getKey())&&oe(n,o,s,i,r);else{if(!G(o,s,i))break;i.mapping.set(o,s)}}for(;f-u-h>0&&c-u-h>0;){const e=a[u],s=l[u],d=a[f-h-1],p=l[c-h-1];if(e instanceof t.XmlText&&s instanceof Array)W(e,s,i)||H(e,s,i),u+=1;else{let l=e instanceof t.XmlElement&&se(e,s),c=d instanceof t.XmlElement&&se(d,p);if(l&&c){const t=q(e,s,i),n=q(d,p,i);t.foundMappedChild&&!n.foundMappedChild?c=!1:!t.foundMappedChild&&n.foundMappedChild||t.equalityFactor<n.equalityFactor?l=!1:c=!1}l?(oe(n,e,s,i,r),u+=1):c?(oe(n,d,p,i,r),h+=1):(i.mapping.delete(o.get(u)),o.delete(u,1),o.insert(u,[z(s,i)]),u+=1)}}const p=f-u-h;if(1===f&&0===c&&a[0]instanceof t.XmlText?(i.mapping.delete(a[0]),a[0].delete(0,a[0].length)):p>0&&(o.slice(u,u+p).forEach(e=>i.mapping.delete(e)),o.delete(u,p)),u+h<c){const e=[];for(let t=u;t<c-h;t++)e.push(z(l[t],i));o.insert(u,e)}},se=(e,t)=>!(t instanceof Array)&&e.nodeName===t.getType(),ie=e.createState("ychange",{isEqual:(e,t)=>e===t,parse:e=>e??null});function re(n,o){const i=o.collabNodeMap.get(n.key);if(void 0===i)return null;let r=n.offset,l=i.getSharedType();if(i instanceof f){l=i._parent._xmlText;const e=i.getOffset();if(-1===e)return null;r=e+1+r}else if(i instanceof u&&"element"===n.type){const t=n.getNode();e.$isElementNode(t)||s(184);let o=0,i=0,l=t.getFirstChild();for(;null!==l&&i++<r;)e.$isTextNode(l)?o+=l.getTextContentSize()+1:o++,l=l.getNextSibling();r=o}return t.createRelativePositionFromTypeIndex(l,r)}function le(n,o){const{mapping:i}=o,{offset:r}=n,l=n.getNode(),c=i.getSharedType(l);if(void 0===c)return null;if("text"===n.type){e.$isTextNode(l)||s(326);let n=l.getPreviousSibling(),o=r;for(;e.$isTextNode(n);)o+=n.getTextContentSize(),n=n.getPreviousSibling();return t.createRelativePositionFromTypeIndex(c,o)}if("element"===n.type){e.$isElementNode(l)||s(184);let n=0,o=l.getFirstChild();for(;null!==o&&n<r;){if(e.$isTextNode(o)){let t=o.getNextSibling();for(;e.$isTextNode(t);)t=t.getNextSibling()}n++,o=o.getNextSibling()}return t.createRelativePositionFromTypeIndex(c,n)}return null}function ce(e,n){return t.createAbsolutePositionFromRelativePosition(e,n.doc)}function ae(e,n){if(null==e){if(null!=n)return!0}else if(null==n||!t.compareRelativePositions(e,n))return!0;return!1}function fe(e,t){return{color:t,name:e,selection:null}}function de(e,t){const n=e.cursorsContainer;if(null!==n){const e=t.selections,o=e.length;for(let t=0;t<o;t++)n.removeChild(e[t])}}function ue(e,t){const n=t.selection;null!==n&&de(e,n)}function he(e,t,n,o,s){const i=e.color,r=document.createElement("span");r.style.cssText=`position:absolute;top:0;bottom:0;right:-1px;width:1px;background-color:${i};z-index:10;`;const l=document.createElement("span");return l.textContent=e.name,l.style.cssText=`position:absolute;left:-2px;top:-16px;background-color:${i};color:#fff;line-height:12px;font-size:12px;padding:2px;font-family:Arial;font-weight:bold;white-space:nowrap;`,r.appendChild(l),{anchor:{key:t,offset:n},caret:r,color:i,focus:{key:o,offset:s},name:l,selections:[]}}function pe(t,n,s,i){const r=t.editor,l=r.getRootElement(),c=t.cursorsContainer;if(null===c||null===l)return;const a=c.offsetParent;if(null===a)return;const f=a.getBoundingClientRect(),d=n.selection;if(null===s)return null===d?void 0:(n.selection=null,void de(t,d));n.selection=s;const u=s.caret,h=s.color,p=s.selections,g=s.anchor,_=s.focus,y=g.key,m=_.key,x=i.get(y),T=i.get(m);if(null==x||null==T)return;let N;if(x===T&&e.$isLineBreakNode(x)){N=[r.getElementByKey(y).getBoundingClientRect()]}else{const e=o.createDOMRange(r,x,g.offset,T,_.offset);if(null===e)return;N=o.createRectsFromDOMRange(r,e)}const S=p.length,E=N.length;for(let e=0;e<E;e++){const t=N[e];let n=p[e];if(void 0===n){n=document.createElement("span"),p[e]=n;const t=document.createElement("span");n.appendChild(t),c.appendChild(n)}const o=`position:absolute;top:${t.top-f.top}px;left:${t.left-f.left}px;height:${t.height}px;width:${t.width}px;pointer-events:none;z-index:5;`;n.style.cssText=o,n.firstChild.style.cssText=`${o}left:0;top:0;background-color:${h};opacity:0.3;`,e===E-1&&u.parentNode!==n&&n.appendChild(u)}for(let e=S-1;e>=E;e--){const t=p[e];c.removeChild(t),p.pop()}}function ge(t,n){const{anchorPos:o,focusPos:s}=n,i=o?ce(o,t):null,r=s?ce(s,t):null;if(null===i||null===r)return{anchorKey:null,anchorOffset:0,focusKey:null,focusOffset:0};if(_(t)){const[e,t]=me(i.type,i.index),[n,o]=me(r.type,r.index);return{anchorKey:null!==e?e.getKey():null,anchorOffset:t,focusKey:null!==n?n.getKey():null,focusOffset:o}}let[l,c]=xe(t.mapping,i),[a,f]=xe(t.mapping,r);if(a&&l&&(a!==l||f!==c)){const t=a.isBefore(l),n=t?a:l,o=t?f:c;e.$isTextNode(n)&&e.$isTextNode(n.getNextSibling())&&o===n.getTextContentSize()&&(t?(a=n.getNextSibling(),f=0):(l=n.getNextSibling(),c=0))}return{anchorKey:null!==l?l.getKey():null,anchorOffset:c,focusKey:null!==a?a.getKey():null,focusOffset:f}}function _e(t,n){const o=n.awareness.getLocalState();if(null===o)return;const{anchorKey:s,anchorOffset:i,focusKey:r,focusOffset:l}=ge(t,o);if(null!==s&&null!==r){const t=e.$getSelection();if(!e.$isRangeSelection(t))return;ye(t.anchor,s,i),ye(t.focus,r,l)}}function ye(t,n,o){if(t.key!==n||t.offset!==o){let s=e.$getNodeByKey(n);if(null!==s&&!e.$isElementNode(s)&&!e.$isTextNode(s)){const e=s.getParentOrThrow();n=e.getKey(),o=s.getIndexWithinParent(),s=e}t.set(n,o,e.$isElementNode(s)?"element":"text")}}function me(e,t){const n=e._collabNode;if(void 0===n)return[null,0];if(n instanceof u){const{node:e,offset:o}=K(n,t,!0);return null===e?[n,0]:[e,o]}return[null,0]}function xe(n,o){const s=o.type,i=o.index;if(s instanceof t.XmlElement){const t=n.get(s);if(void 0===t)return[null,0];if(!e.$isElementNode(t))return[t,i];let o=i,r=0;const l=t.getChildren();for(;o>0&&r<l.length;){const t=l[r];if(o-=1,r+=1,e.$isTextNode(t))for(;r<l.length&&e.$isTextNode(l[r]);)r+=1}return[t,r]}{const e=n.get(s);if(void 0===e)return[null,0];let t=0,o=i;for(;o>e[t].getTextContentSize()&&t+1<e.length;)o-=e[t].getTextContentSize(),t++;const r=e[t];return[r,Math.min(o,r.getTextContentSize())]}}function Te(e,t){return t.awareness.getStates()}function Ne(e,t,n){const{getAwarenessStates:o=Te}=n??{},s=Array.from(o(e,t)),i=e.clientID,r=e.cursors,l=e.editor,c=l._editorState._nodeMap,a=new Set;for(let t=0;t<s.length;t++){const n=s[t],[o,f]=n;if(0!==o&&o!==i){a.add(o);const{name:t,color:n,focusing:s}=f;let i=null,d=r.get(o);if(void 0===d&&(d=fe(t,n),r.set(o,d)),s){const{anchorKey:t,anchorOffset:n,focusKey:o,focusOffset:s}=l.read(()=>ge(e,f));if(null!==t&&null!==o)if(i=d.selection,null===i)i=he(d,t,n,o,s);else{const e=i.anchor,r=i.focus;e.key=t,e.offset=n,r.key=o,r.offset=s}}pe(e,d,i,c)}}const f=Array.from(r.keys());for(let t=0;t<f.length;t++){const n=f[t];if(!a.has(n)){const t=r.get(n);void 0!==t&&(ue(e,t),r.delete(n))}}}function Se(t,n,o,s){const i=n.awareness,r=i.getLocalState();if(null===r)return;const{anchorPos:l,focusPos:c,name:a,color:f,focusing:d,awarenessData:u}=r;let h=null,p=null;(null!==s&&(null===l||s.is(o))||null!==o)&&(e.$isRangeSelection(s)&&(_(t)?(h=re(s.anchor,t),p=re(s.focus,t)):(h=le(s.anchor,t),p=le(s.focus,t))),(ae(l,h)||ae(c,p))&&i.setLocalState({...r,anchorPos:h,awarenessData:u,color:f,focusPos:p,focusing:d,name:a}))}function Ee(n,o){if(o instanceof t.YMapEvent&&function(n,o){const{target:s}=o;if(!s._item||"__state"!==s._item.parentSub||void 0!==b(s)||!(s.parent instanceof t.XmlText||s.parent instanceof t.XmlElement||s.parent instanceof t.Map))return!1;const i=C(n,s.parent).getNode();if(i){const t=e.$getWritableNodeState(i.getWritable());for(const e of o.keysChanged)t.updateFromUnknown(e,s.get(e))}return!0}(n,o))return;const{target:i}=o,l=C(n,i);if(l instanceof u&&o instanceof t.YTextEvent){const{keysChanged:e,childListChanged:t,delta:s}=o;e.size>0&&l.syncPropertiesFromYjs(n,e),t&&(l.applyChildrenYjsDelta(n,s),l.syncChildrenFromYjs(n))}else if(l instanceof f&&o instanceof t.YMapEvent){const{keysChanged:e}=o;e.size>0&&l.syncPropertiesAndTextFromYjs(n,e)}else if(l instanceof r&&o instanceof t.YXmlEvent){const{attributesChanged:e}=o;e.size>0&&l.syncPropertiesFromYjs(n,e)}else s(82)}function be(t,n,o){const s=e.$getSelection();if(e.$isRangeSelection(s))if(P(s)){const i=t._selection;if(e.$isRangeSelection(i)&&(_e(n,o),P(s))){F(s.anchor.key,t)}Se(n,o,i,e.$getSelection())}else _e(n,o)}function Ce(){0===e.$getRoot().getChildrenSize()&&e.$getRoot().append(e.$createParagraphNode())}function ke(e,n){const{target:o}=n;if(o instanceof t.XmlElement&&n instanceof t.YXmlEvent)R(o,e,n.attributesChanged,n.childListChanged);else if(o instanceof t.XmlText&&n instanceof t.YTextEvent){const n=o.parent;n instanceof t.XmlElement?R(n,e,new Set,!0):s(327)}else s(328)}const $e=e.createCommand("CONNECTED_COMMAND"),Oe=e.createCommand("TOGGLE_CONNECT_COMMAND"),ve=e.createCommand("DIFF_VERSIONS_COMMAND"),Ae=e.createCommand("CLEAR_DIFF_VERSIONS_COMMAND");exports.$getYChangeState=function(t){return e.$getState(t,ie)},exports.CLEAR_DIFF_VERSIONS_COMMAND__EXPERIMENTAL=Ae,exports.CONNECTED_COMMAND=$e,exports.DIFF_VERSIONS_COMMAND__EXPERIMENTAL=ve,exports.TOGGLE_CONNECT_COMMAND=Oe,exports.createBinding=function(e,n,o,i,r,l){null==i&&s(81);const c=h(i.get("root",t.XmlText),null,"root");return c._key="root",{...g(e,o,i,r,l),collabNodeMap:new Map,root:c}},exports.createBindingV2__EXPERIMENTAL=function(e,n,o,i,r={}){null==o&&s(81);const{excludedProperties:l,rootName:c="root-v2"}=r;return{...g(e,n,o,i,l),mapping:new p,root:o.get(c,t.XmlElement)}},exports.createUndoManager=function(e,n){return new t.UndoManager(n,{trackedOrigins:new Set([e,null])})},exports.getAnchorAndFocusCollabNodesForUserState=function(e,t){const{anchorPos:n,focusPos:o}=t;let s=null,i=0,r=null,l=0;if(null!==n&&null!==o){const t=ce(n,e),c=ce(o,e);null!==t&&null!==c&&([s,i]=me(t.type,t.index),[r,l]=me(c.type,c.index))}return{anchorCollabNode:s,anchorOffset:i,focusCollabNode:r,focusOffset:l}},exports.initLocalState=function(e,t,n,o,s){e.awareness.setLocalState({anchorPos:null,awarenessData:s,color:n,focusPos:null,focusing:o,name:t})},exports.renderSnapshot__EXPERIMENTAL=(n,o=t.snapshot(n.doc),i=t.emptySnapshot)=>{const{doc:r}=n;r.gc&&s(325),r.transact(s=>{const l=new t.PermanentUserData(r);l&&l.dss.forEach(e=>{t.iterateDeletedStructs(s,e,e=>{})});const c=(e,t)=>({id:t,type:e,user:("added"===e?l.getUserByClientId(t.client):l.getUserByDeletedId(t))??null});n.mapping.clear(),n.editor.update(()=>{e.$getRoot().clear(),R(n.root,n,null,!0,o,i,c)})},n)},exports.setLocalStateFocus=function(e,t,n,o,s){const{awareness:i}=e;let r=i.getLocalState();null===r&&(r={anchorPos:null,awarenessData:s,color:n,focusPos:null,focusing:o,name:t}),r.focusing=o,i.setLocalState(r)},exports.syncCursorPositions=Ne,exports.syncLexicalUpdateToYjs=function(t,n,o,s,i,r,l,c){L(t,()=>{s.read(()=>{if(c.has(e.COLLABORATION_TAG)||c.has(e.HISTORIC_TAG))return void(l.size>0&&function(t,n){const o=Array.from(n),s=t.collabNodeMap,i=[],r=[];for(let t=0;t<o.length;t++){const n=o[t],l=e.$getNodeByKey(n),c=s.get(n);if(c instanceof f)if(e.$isTextNode(l))i.push([c,l.__text]);else{const e=c.getOffset();if(-1===e)continue;const t=c._parent;c._normalized=!0,t._xmlText.delete(e,1),r.push(c)}}for(let e=0;e<r.length;e++){const t=r[e],n=t.getKey();s.delete(n);const o=t._parent._children,i=o.indexOf(t);o.splice(i,1)}for(let e=0;e<i.length;e++){const[t,n]=i[e];t._text=n}}(t,l));if(i.has("root")){const n=o._nodeMap,s=e.$getRoot(),l=t.root;l.syncPropertiesFromLexical(t,s,n),l.syncChildrenFromLexical(t,s,n,i,r)}const s=e.$getSelection(),a=o._selection;Se(t,n,a,s)})})},exports.syncLexicalUpdateToYjsV2__EXPERIMENTAL=function(t,n,o,s,i,r,l){(l.has(e.COLLABORATION_TAG)||l.has(e.HISTORIC_TAG))&&0===r.size||(r.forEach(e=>{t.mapping.deleteNode(e)}),L(t,()=>{s.read(()=>{i.has("root")&&oe(t.doc,t.root,e.$getRoot(),t,new Set(i.keys()));const s=e.$getSelection(),r=o._selection;Se(t,n,r,s)})}))},exports.syncYjsChangesToLexical=function(t,n,o,s,i=Ne){const r=t.editor,l=r._editorState;o.forEach(e=>e.delta),r.update(()=>{for(let e=0;e<o.length;e++){const n=o[e];Ee(t,n)}be(l,t,n),s||e.$addUpdateTag(e.SKIP_SCROLL_INTO_VIEW_TAG)},{onUpdate:()=>{i(t,n),r.update(()=>Ce())},skipTransforms:!0,tag:s?e.HISTORIC_TAG:e.COLLABORATION_TAG})},exports.syncYjsChangesToLexicalV2__EXPERIMENTAL=function(n,o,s,i,r){const l=n.editor,c=l._editorState;t.iterateDeletedStructs(i,i.deleteSet,e=>{if(e.constructor===t.Item){const t=e.content.type;t&&n.mapping.delete(t)}}),s.forEach(e=>e.delta),l.update(()=>{for(let e=0;e<s.length;e++){const t=s[e];ke(n,t)}be(c,n,o),r||e.$addUpdateTag(e.SKIP_SCROLL_INTO_VIEW_TAG)},{discrete:!0,onUpdate:()=>{Ne(n,o),l.update(()=>Ce())},skipTransforms:!0,tag:r?e.HISTORIC_TAG:e.COLLABORATION_TAG})},exports.syncYjsStateToLexicalV2__EXPERIMENTAL=function(t,n){t.mapping.clear();const o=t.editor;o.update(()=>{e.$getRoot().clear(),R(t.root,t,null,!0),e.$addUpdateTag(e.COLLABORATION_TAG)},{discrete:!0,onUpdate:()=>{Ne(t,n),o.update(()=>Ce())},skipTransforms:!0,tag:e.COLLABORATION_TAG})};
