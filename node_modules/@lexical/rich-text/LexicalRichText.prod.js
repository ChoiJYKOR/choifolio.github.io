/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 */

"use strict";var e=require("@lexical/clipboard"),t=require("@lexical/dragon"),n=require("@lexical/selection"),r=require("@lexical/utils"),o=require("lexical");function i(e,t){if(void 0!==document.caretRangeFromPoint){const n=document.caretRangeFromPoint(e,t);return null===n?null:{node:n.startContainer,offset:n.startOffset}}if("undefined"!==document.caretPositionFromPoint){const n=document.caretPositionFromPoint(e,t);return null===n?null:{node:n.offsetNode,offset:n.offset}}return null}const s="undefined"!=typeof window&&void 0!==window.document&&void 0!==window.document.createElement,a=s&&"documentMode"in document?document.documentMode:null,c=s&&/Mac|iPod|iPhone|iPad/.test(navigator.platform),l=!(!s||!("InputEvent"in window)||a)&&"getTargetRanges"in new window.InputEvent("input"),u=s&&/Version\/[\d.]+.*Safari/.test(navigator.userAgent),d=s&&/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,g=s&&/^(?=.*Chrome).*/i.test(navigator.userAgent),O=s&&/AppleWebKit\/[\d.]+/.test(navigator.userAgent)&&c&&!g,R=o.createCommand("DRAG_DROP_PASTE_FILE");class N extends o.ElementNode{static getType(){return"quote"}static clone(e){return new N(e.__key)}createDOM(e){const t=document.createElement("blockquote");return r.addClassNamesToElement(t,e.theme.quote),t}updateDOM(e,t){return!1}static importDOM(){return{blockquote:e=>({conversion:f,priority:0})}}exportDOM(e){const{element:t}=super.exportDOM(e);if(r.isHTMLElement(t)){this.isEmpty()&&t.append(document.createElement("br"));const e=this.getFormatType();e&&(t.style.textAlign=e);const n=this.getDirection();n&&(t.dir=n)}return{element:t}}static importJSON(e){return D().updateFromJSON(e)}insertNewAfter(e,t){const n=o.$createParagraphNode(),r=this.getDirection();return n.setDirection(r),this.insertAfter(n,t),n}collapseAtStart(){const e=o.$createParagraphNode();return this.getChildren().forEach(t=>e.append(t)),this.replace(e),!0}canMergeWhenEmpty(){return!0}}function D(){return o.$applyNodeReplacement(new N)}class m extends o.ElementNode{__tag;static getType(){return"heading"}static clone(e){return new m(e.__tag,e.__key)}constructor(e,t){super(t),this.__tag=e}getTag(){return this.__tag}setTag(e){const t=this.getWritable();return this.__tag=e,t}createDOM(e){const t=this.__tag,n=document.createElement(t),o=e.theme.heading;if(void 0!==o){const e=o[t];r.addClassNamesToElement(n,e)}return n}updateDOM(e,t,n){return e.__tag!==this.__tag}static importDOM(){return{h1:e=>({conversion:_,priority:0}),h2:e=>({conversion:_,priority:0}),h3:e=>({conversion:_,priority:0}),h4:e=>({conversion:_,priority:0}),h5:e=>({conversion:_,priority:0}),h6:e=>({conversion:_,priority:0}),p:e=>{const t=e.firstChild;return null!==t&&M(t)?{conversion:()=>({node:null}),priority:3}:null},span:e=>M(e)?{conversion:e=>({node:T("h1")}),priority:3}:null}}exportDOM(e){const{element:t}=super.exportDOM(e);if(r.isHTMLElement(t)){this.isEmpty()&&t.append(document.createElement("br"));const e=this.getFormatType();e&&(t.style.textAlign=e);const n=this.getDirection();n&&(t.dir=n)}return{element:t}}static importJSON(e){return T(e.tag).updateFromJSON(e)}updateFromJSON(e){return super.updateFromJSON(e).setTag(e.tag)}exportJSON(){return{...super.exportJSON(),tag:this.getTag()}}insertNewAfter(e,t=!0){const n=e?e.anchor.offset:0,r=this.getLastDescendant(),i=!r||e&&e.anchor.key===r.getKey()&&n===r.getTextContentSize()||!e?o.$createParagraphNode():T(this.getTag()),s=this.getDirection();if(i.setDirection(s),this.insertAfter(i,t),0===n&&!this.isEmpty()&&e){const e=o.$createParagraphNode();e.select(),this.replace(e,!0)}return i}collapseAtStart(){const e=this.isEmpty()?o.$createParagraphNode():T(this.getTag());return this.getChildren().forEach(t=>e.append(t)),this.replace(e),!0}extractWithChild(){return!0}}function M(e){return"span"===e.nodeName.toLowerCase()&&"26pt"===e.style.fontSize}function _(e){const t=e.nodeName.toLowerCase();let n=null;return"h1"!==t&&"h2"!==t&&"h3"!==t&&"h4"!==t&&"h5"!==t&&"h6"!==t||(n=T(t),null!==e.style&&(o.setNodeIndentFromDOM(e,n),n.setFormat(e.style.textAlign))),{node:n}}function f(e){const t=D();return null!==e.style&&(t.setFormat(e.style.textAlign),o.setNodeIndentFromDOM(e,t)),{node:t}}function T(e="h1"){return o.$applyNodeReplacement(new m(e))}function C(e){let t=null;if(r.objectKlassEquals(e,DragEvent)?t=e.dataTransfer:r.objectKlassEquals(e,ClipboardEvent)&&(t=e.clipboardData),null===t)return[!1,[],!1];const n=t.types,o=n.includes("Files"),i=n.includes("text/html")||n.includes("text/plain");return[o,Array.from(t.files),i]}function E(e){const t=o.$getSelection();if(!o.$isRangeSelection(t))return!1;const n=new Set,i=t.getNodes();for(let t=0;t<i.length;t++){const s=i[t],a=s.getKey();if(n.has(a))continue;const c=r.$findMatchingParent(s,e=>o.$isElementNode(e)&&!e.isInline());if(null===c)continue;const l=c.getKey();c.canIndent()&&!n.has(l)&&(n.add(l),e(c))}return n.size>0}function p(e){const t=o.$getNearestNodeFromDOMNode(e);return o.$isDecoratorNode(t)}function I(e){for(const t of["lowercase","uppercase","capitalize"])e.hasFormat(t)&&e.toggleFormat(t)}function A(t){const s=r.mergeRegister(t.registerCommand(o.CLICK_COMMAND,e=>{const t=o.$getSelection();return!!o.$isNodeSelection(t)&&(t.clear(),!0)},o.COMMAND_PRIORITY_EDITOR),t.registerCommand(o.DELETE_CHARACTER_COMMAND,e=>{const t=o.$getSelection();return o.$isRangeSelection(t)?(t.deleteCharacter(e),!0):!!o.$isNodeSelection(t)&&(t.deleteNodes(),!0)},o.COMMAND_PRIORITY_EDITOR),t.registerCommand(o.DELETE_WORD_COMMAND,e=>{const t=o.$getSelection();return!!o.$isRangeSelection(t)&&(t.deleteWord(e),!0)},o.COMMAND_PRIORITY_EDITOR),t.registerCommand(o.DELETE_LINE_COMMAND,e=>{const t=o.$getSelection();return!!o.$isRangeSelection(t)&&(t.deleteLine(e),!0)},o.COMMAND_PRIORITY_EDITOR),t.registerCommand(o.CONTROLLED_TEXT_INSERTION_COMMAND,n=>{const r=o.$getSelection();if("string"==typeof n)null!==r&&r.insertText(n);else{if(null===r)return!1;const i=n.dataTransfer;if(null!=i)e.$insertDataTransferForRichText(i,r,t);else if(o.$isRangeSelection(r)){const e=n.data;return e&&r.insertText(e),!0}}return!0},o.COMMAND_PRIORITY_EDITOR),t.registerCommand(o.REMOVE_TEXT_COMMAND,()=>{const e=o.$getSelection();return!!o.$isRangeSelection(e)&&(e.removeText(),!0)},o.COMMAND_PRIORITY_EDITOR),t.registerCommand(o.FORMAT_TEXT_COMMAND,e=>{const t=o.$getSelection();return!!o.$isRangeSelection(t)&&(t.formatText(e),!0)},o.COMMAND_PRIORITY_EDITOR),t.registerCommand(o.FORMAT_ELEMENT_COMMAND,e=>{const t=o.$getSelection();if(!o.$isRangeSelection(t)&&!o.$isNodeSelection(t))return!1;const n=t.getNodes();for(const t of n){const n=r.$findMatchingParent(t,e=>o.$isElementNode(e)&&!e.isInline());null!==n&&n.setFormat(e)}return!0},o.COMMAND_PRIORITY_EDITOR),t.registerCommand(o.INSERT_LINE_BREAK_COMMAND,e=>{const t=o.$getSelection();return!!o.$isRangeSelection(t)&&(t.insertLineBreak(e),!0)},o.COMMAND_PRIORITY_EDITOR),t.registerCommand(o.INSERT_PARAGRAPH_COMMAND,()=>{const e=o.$getSelection();return!!o.$isRangeSelection(e)&&(e.insertParagraph(),!0)},o.COMMAND_PRIORITY_EDITOR),t.registerCommand(o.INSERT_TAB_COMMAND,()=>(o.$insertNodes([o.$createTabNode()]),!0),o.COMMAND_PRIORITY_EDITOR),t.registerCommand(o.INDENT_CONTENT_COMMAND,()=>E(e=>{const t=e.getIndent();e.setIndent(t+1)}),o.COMMAND_PRIORITY_EDITOR),t.registerCommand(o.OUTDENT_CONTENT_COMMAND,()=>E(e=>{const t=e.getIndent();t>0&&e.setIndent(Math.max(0,t-1))}),o.COMMAND_PRIORITY_EDITOR),t.registerCommand(o.KEY_ARROW_UP_COMMAND,e=>{const t=o.$getSelection();if(o.$isNodeSelection(t)){const n=t.getNodes();if(n.length>0)return e.preventDefault(),n[0].selectPrevious(),!0}else if(o.$isRangeSelection(t)){const n=o.$getAdjacentNode(t.focus,!0);if(!e.shiftKey&&o.$isDecoratorNode(n)&&!n.isIsolated()&&!n.isInline())return n.selectPrevious(),e.preventDefault(),!0}return!1},o.COMMAND_PRIORITY_EDITOR),t.registerCommand(o.KEY_ARROW_DOWN_COMMAND,e=>{const t=o.$getSelection();if(o.$isNodeSelection(t)){const n=t.getNodes();if(n.length>0)return e.preventDefault(),n[0].selectNext(0,0),!0}else if(o.$isRangeSelection(t)){if(function(e){const t=e.focus;return"root"===t.key&&t.offset===o.$getRoot().getChildrenSize()}(t))return e.preventDefault(),!0;const n=o.$getAdjacentNode(t.focus,!1);if(!e.shiftKey&&o.$isDecoratorNode(n)&&!n.isIsolated()&&!n.isInline())return n.selectNext(),e.preventDefault(),!0}return!1},o.COMMAND_PRIORITY_EDITOR),t.registerCommand(o.KEY_ARROW_LEFT_COMMAND,e=>{const t=o.$getSelection();if(o.$isNodeSelection(t)){const r=t.getNodes();if(r.length>0)return e.preventDefault(),n.$isParentRTL(r[0])?r[0].selectNext(0,0):r[0].selectPrevious(),!0}if(!o.$isRangeSelection(t))return!1;if(n.$shouldOverrideDefaultCharacterSelection(t,!0)){const r=e.shiftKey;return e.preventDefault(),n.$moveCharacter(t,r,!0),!0}return!1},o.COMMAND_PRIORITY_EDITOR),t.registerCommand(o.KEY_ARROW_RIGHT_COMMAND,e=>{const t=o.$getSelection();if(o.$isNodeSelection(t)){const r=t.getNodes();if(r.length>0)return e.preventDefault(),n.$isParentRTL(r[0])?r[0].selectPrevious():r[0].selectNext(0,0),!0}if(!o.$isRangeSelection(t))return!1;const r=e.shiftKey;return!!n.$shouldOverrideDefaultCharacterSelection(t,!1)&&(e.preventDefault(),n.$moveCharacter(t,r,!1),!0)},o.COMMAND_PRIORITY_EDITOR),t.registerCommand(o.KEY_BACKSPACE_COMMAND,e=>{if(p(e.target))return!1;const n=o.$getSelection();if(o.$isRangeSelection(n)){if(function(e){if(!e.isCollapsed())return!1;const{anchor:t}=e;if(0!==t.offset)return!1;const n=t.getNode();if(o.$isRootNode(n))return!1;const i=r.$getNearestBlockElementAncestorOrThrow(n);return i.getIndent()>0&&(i.is(n)||n.is(i.getFirstDescendant()))}(n))return e.preventDefault(),t.dispatchCommand(o.OUTDENT_CONTENT_COMMAND,void 0);if(d&&"ko-KR"===navigator.language)return!1}else if(!o.$isNodeSelection(n))return!1;return e.preventDefault(),t.dispatchCommand(o.DELETE_CHARACTER_COMMAND,!0)},o.COMMAND_PRIORITY_EDITOR),t.registerCommand(o.KEY_DELETE_COMMAND,e=>{if(p(e.target))return!1;const n=o.$getSelection();return!(!o.$isRangeSelection(n)&&!o.$isNodeSelection(n))&&(e.preventDefault(),t.dispatchCommand(o.DELETE_CHARACTER_COMMAND,!1))},o.COMMAND_PRIORITY_EDITOR),t.registerCommand(o.KEY_ENTER_COMMAND,e=>{const n=o.$getSelection();if(!o.$isRangeSelection(n))return!1;if(I(n),null!==e){if((d||u||O)&&l)return!1;if(e.preventDefault(),e.shiftKey)return t.dispatchCommand(o.INSERT_LINE_BREAK_COMMAND,!1)}return t.dispatchCommand(o.INSERT_PARAGRAPH_COMMAND,void 0)},o.COMMAND_PRIORITY_EDITOR),t.registerCommand(o.KEY_ESCAPE_COMMAND,()=>{const e=o.$getSelection();return!!o.$isRangeSelection(e)&&(t.blur(),!0)},o.COMMAND_PRIORITY_EDITOR),t.registerCommand(o.DROP_COMMAND,e=>{const[,n]=C(e);if(n.length>0){const r=i(e.clientX,e.clientY);if(null!==r){const{offset:e,node:i}=r,s=o.$getNearestNodeFromDOMNode(i);if(null!==s){const t=o.$createRangeSelection();if(o.$isTextNode(s))t.anchor.set(s.getKey(),e,"text"),t.focus.set(s.getKey(),e,"text");else{const e=s.getParentOrThrow().getKey(),n=s.getIndexWithinParent()+1;t.anchor.set(e,n,"element"),t.focus.set(e,n,"element")}const n=o.$normalizeSelection__EXPERIMENTAL(t);o.$setSelection(n)}t.dispatchCommand(R,n)}return e.preventDefault(),!0}const r=o.$getSelection();return!!o.$isRangeSelection(r)},o.COMMAND_PRIORITY_EDITOR),t.registerCommand(o.DRAGSTART_COMMAND,e=>{const[t]=C(e),n=o.$getSelection();return!(t&&!o.$isRangeSelection(n))},o.COMMAND_PRIORITY_EDITOR),t.registerCommand(o.DRAGOVER_COMMAND,e=>{const[t]=C(e),n=o.$getSelection();if(t&&!o.$isRangeSelection(n))return!1;const r=i(e.clientX,e.clientY);if(null!==r){const t=o.$getNearestNodeFromDOMNode(r.node);o.$isDecoratorNode(t)&&e.preventDefault()}return!0},o.COMMAND_PRIORITY_EDITOR),t.registerCommand(o.SELECT_ALL_COMMAND,()=>(o.$selectAll(),!0),o.COMMAND_PRIORITY_EDITOR),t.registerCommand(o.COPY_COMMAND,n=>(e.copyToClipboard(t,r.objectKlassEquals(n,ClipboardEvent)?n:null),!0),o.COMMAND_PRIORITY_EDITOR),t.registerCommand(o.CUT_COMMAND,n=>(async function(t,n){await e.copyToClipboard(n,r.objectKlassEquals(t,ClipboardEvent)?t:null),n.update(()=>{const e=o.$getSelection();o.$isRangeSelection(e)?e.removeText():o.$isNodeSelection(e)&&e.getNodes().forEach(e=>e.remove())})}(n,t),!0),o.COMMAND_PRIORITY_EDITOR),t.registerCommand(o.PASTE_COMMAND,n=>{const[,i,s]=C(n);if(i.length>0&&!s)return t.dispatchCommand(R,i),!0;if(o.isDOMNode(n.target)&&o.isSelectionCapturedInDecoratorInput(n.target))return!1;return null!==o.$getSelection()&&(function(t,n){t.preventDefault(),n.update(()=>{const i=o.$getSelection(),s=r.objectKlassEquals(t,InputEvent)||r.objectKlassEquals(t,KeyboardEvent)?null:t.clipboardData;null!=s&&null!==i&&e.$insertDataTransferForRichText(s,i,n)},{tag:o.PASTE_TAG})}(n,t),!0)},o.COMMAND_PRIORITY_EDITOR),t.registerCommand(o.KEY_SPACE_COMMAND,e=>{const t=o.$getSelection();return o.$isRangeSelection(t)&&I(t),!1},o.COMMAND_PRIORITY_EDITOR),t.registerCommand(o.KEY_TAB_COMMAND,e=>{const t=o.$getSelection();return o.$isRangeSelection(t)&&I(t),!1},o.COMMAND_PRIORITY_EDITOR));return s}const h=o.defineExtension({conflictsWith:["@lexical/plain-text"],dependencies:[t.DragonExtension],name:"@lexical/rich-text",nodes:[m,N],register:A});exports.$createHeadingNode=T,exports.$createQuoteNode=D,exports.$isHeadingNode=function(e){return e instanceof m},exports.$isQuoteNode=function(e){return e instanceof N},exports.DRAG_DROP_PASTE=R,exports.HeadingNode=m,exports.QuoteNode=N,exports.RichTextExtension=h,exports.eventFiles=C,exports.registerRichText=A;
