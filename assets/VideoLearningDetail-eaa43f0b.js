import{O as z,P as q,A as G,B as W,j as X,r as o,k as e,X as Z,L as j,q as c,R as Q,K as P,N as I,l as m,E as O,G as ee,Z as ae,_ as te,T as se,$ as re,a0 as ie,a1 as ne}from"./index-1fe3a1ef.js";import{f as S}from"./dateUtils-19c0cc10.js";import{a as oe,b as le,c as de}from"./useVideoLearnings-3ce11622.js";import{u as ce}from"./useSkills-77227ec9.js";import{e as me,r as xe}from"./videoUtils-df590320.js";import{R as pe}from"./RichTextEditor-fcc52ff1.js";import{d as ye,E as ge}from"./detector-bcdba050.js";import{u as ue}from"./useToast-1773be8d.js";import{S as he,M as A}from"./StickyVideoPlayer-560e3893.js";import"./useMutation-31c06883.js";const Re=()=>{const{id:y}=z(),D=q(),T=G(),{isAuthenticated:g}=W(),{i18n:V,t:x}=X(),l=V.language,{data:a,isLoading:J,isError:fe,error:ke}=oe(y),E=le(),u=de(),{skillCategories:f}=ce(),{success:M,error:Y}=ue(),d=o.useRef(null),k=o.useRef(null),[L,C]=o.useState(!1),[w,b]=o.useState(!1),[F,h]=o.useState(""),p=o.useMemo(()=>a!=null&&a.videoId?a.videoId:a!=null&&a.videoUrl?me(a.videoUrl):null,[a]);o.useEffect(()=>{if(!p)return;if(!window.YT){const s=document.createElement("script");s.src="https://www.youtube.com/iframe_api";const r=document.getElementsByTagName("script")[0];r!=null&&r.parentNode&&r.parentNode.insertBefore(s,r)}const t=()=>{window.YT&&window.YT.Player&&k.current&&(d.current=new window.YT.Player(k.current,{videoId:p,playerVars:{enablejsapi:1,origin:window.location.origin,rel:0,modestbranding:1,fs:1,cc_load_policy:0,iv_load_policy:3,showinfo:0,controls:1},events:{onReady:()=>{console.log("✅ 유튜브 플레이어 준비 완료"),C(!0)}}}))};return window.YT&&window.YT.Player?t():window.onYouTubeIframeAPIReady=t,()=>{d.current&&typeof d.current.destroy=="function"&&d.current.destroy()}},[p]);const R=o.useMemo(()=>!(a!=null&&a.skillIds)||!f?[]:f.flatMap(s=>s.skills||[]).filter(s=>{var r;return s._id&&((r=a.skillIds)==null?void 0:r.includes(s._id))}),[a,f]),B=t=>{if(console.log(`⏰ 타임스탬프 클릭: ${t}초로 이동 + 자동 재생`),!d.current||!L){console.warn("⚠️ 플레이어가 아직 준비되지 않았습니다");return}try{d.current.seekTo(t,!0),d.current.playVideo(),console.log(`✅ ${t}초로 이동 후 재생 시작`)}catch(s){console.error("플레이어 제어 오류:",s)}},$=async()=>{if(confirm("이 영상 학습 기록을 삭제하시겠습니까?"))try{await E.mutateAsync(y),D("/video-learnings")}catch(t){console.error("Failed to delete video learning:",t)}},U=()=>{b(!0),h((a==null?void 0:a.keyTakeaways)||"")},H=()=>{b(!1),h("")},K=async()=>{var t,s,r;if(!(!a||!y))try{const n=(a.skillIds||[]).map(i=>typeof i=="string"?i:i==null?void 0:i._id).filter(Boolean),v=(a.categoryIds||[]).map(i=>typeof i=="string"?i:i==null?void 0:i._id).filter(Boolean),_={title:a.title,videoId:a.videoId,category:a.category,categoryIds:v,watchDate:a.watchDate,purpose:a.purpose,keyTakeaways:F,application:a.application,skillIds:n,rating:a.rating,order:a.order};console.log("📤 전송 데이터:",_),await u.mutateAsync({id:y,data:_}),M("저장 완료","핵심 배움이 저장되었습니다."),b(!1),h("")}catch(n){console.error("핵심 배움 저장 실패:",n),console.error("📋 서버 응답 상세:",(t=n.response)==null?void 0:t.data),Y("저장 실패",((r=(s=n.response)==null?void 0:s.data)==null?void 0:r.message)||"핵심 배움 저장 중 오류가 발생했습니다.")}},N=E.isPending;return J?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"w-12 h-12 border-4 border-primary-600 border-t-transparent rounded-full animate-spin"})}):a?e.jsx("section",{className:"min-h-screen bg-white dark:bg-dark-900",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-4 py-8",children:[e.jsx(c.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},children:e.jsxs(j,{to:"/video-learnings",state:T.state,className:"inline-flex items-center gap-2 text-primary-600 hover:text-primary-700 mb-6",children:[e.jsx(Q,{})," ",x("videoLearnings.backToList")]})}),e.jsxs("div",{className:"flex flex-col lg:flex-row gap-6",children:[e.jsxs("div",{className:"w-full lg:w-7/12 lg:sticky lg:top-8 self-start",children:[p&&e.jsxs(c.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"mb-6",children:[e.jsx(he,{videoId:p,playerRef:k,onPlayerReady:()=>C(!0)}),!L&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-900 bg-opacity-75 rounded-xl pointer-events-none",children:e.jsx("div",{className:"w-12 h-12 border-4 border-white border-t-transparent rounded-full animate-spin"})})]}),e.jsxs(c.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.1},className:"card p-6 mb-6",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsx("div",{className:"flex flex-wrap gap-2",children:a.categoryIds&&a.categoryIds.length>0?a.categoryIds.map(t=>{const s=typeof t=="string"?t:t==null?void 0:t.name;return s?e.jsx("span",{className:"px-3 py-1 bg-primary-100 dark:bg-primary-900 text-primary-800 dark:text-primary-200 rounded-full text-sm font-medium",children:s},typeof t=="string"?t:t==null?void 0:t._id):null}):a.category&&e.jsx("span",{className:"px-3 py-1 bg-primary-100 dark:bg-primary-900 text-primary-800 dark:text-primary-200 rounded-full text-sm font-medium",children:a.category})}),g&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx(j,{to:"/admin",state:{tab:"videoLearnings",editId:a._id},className:"p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-blue-600 dark:text-blue-400","aria-label":"영상 수정",children:e.jsx(P,{})}),e.jsx("button",{onClick:$,disabled:N,className:`p-2 rounded-lg text-red-600 dark:text-red-400 transition-colors ${N?"opacity-50 cursor-not-allowed":"hover:bg-gray-100 dark:hover:bg-gray-700"}`,"aria-label":"영상 삭제",children:N?e.jsx("div",{className:"w-4 h-4 border-2 border-red-600 border-t-transparent rounded-full animate-spin"}):e.jsx(I,{})})]})]}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-4",children:m(l,a.title,a.titleEn,a.titleJa)}),e.jsxs("div",{className:"flex flex-wrap gap-4 text-sm text-gray-600 dark:text-gray-400",children:[a.rating&&e.jsxs("div",{className:"flex items-center gap-2",children:[Array.from({length:5},(t,s)=>e.jsx(O,{className:`text-sm ${s<a.rating?"text-yellow-500":"text-gray-300 dark:text-gray-600"}`},s)),e.jsxs("span",{className:"font-medium",children:[a.rating,"/5"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ee,{}),e.jsx("span",{children:S(a.watchDate)})]})]})]}),m(l,a.purpose,a.purposeEn,a.purposeJa)&&e.jsxs(c.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.2},className:"card p-6 mb-6",children:[e.jsxs("h3",{className:"text-lg font-bold text-gray-900 dark:text-white mb-3 flex items-center gap-2",children:[e.jsx(ae,{className:"text-blue-600"})," ",x("videoLearnings.purpose")]}),e.jsx("div",{className:"prose dark:prose-invert max-w-none text-gray-700 dark:text-gray-300 text-sm",children:e.jsx(A,{children:m(l,a.purpose,a.purposeEn,a.purposeJa)||""})})]}),m(l,a.application,a.applicationEn,a.applicationJa)&&e.jsxs(c.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},className:"card p-6 bg-gradient-to-br from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 border-l-4 border-purple-600",children:[e.jsxs("h3",{className:"text-lg font-bold text-gray-900 dark:text-white mb-3 flex items-center gap-2",children:[e.jsx(te,{className:"text-purple-600"})," ",x("videoLearnings.application")]}),e.jsx("div",{className:"prose dark:prose-invert max-w-none text-gray-700 dark:text-gray-300 text-sm",children:e.jsx(A,{children:m(l,a.application,a.applicationEn,a.applicationJa)||""})})]})]}),e.jsxs("div",{className:"w-full lg:w-5/12 space-y-6",children:[R.length>0&&e.jsxs(c.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.2},className:"card p-6",children:[e.jsxs("h3",{className:"text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2",children:[e.jsx(se,{className:"text-primary-600"})," 학습한 기술"]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:R.map(t=>e.jsx("div",{className:"inline-flex items-center px-3 py-1 rounded-lg text-sm font-medium",style:{backgroundColor:`${t.color}26`,color:t.color},children:t.name},t._id))})]}),(a.keyTakeaways||g)&&e.jsxs(c.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},className:"card p-6 bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 border-l-4 border-blue-600",children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2",children:[e.jsx(re,{className:"text-yellow-500"})," ",x("videoLearnings.keyTakeaways")]}),g&&!w&&e.jsx("button",{onClick:U,className:"p-1.5 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded transition-colors",title:"핵심 배움 편집",children:e.jsx(P,{className:"text-sm"})})]}),a.createdAt&&e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:[x("videoLearnings.recordedDate")," ",S(a.createdAt)]})]}),!w&&e.jsx(e.Fragment,{children:m(l,a.keyTakeaways,a.keyTakeawaysEn,a.keyTakeawaysJa)?e.jsx(e.Fragment,{children:(()=>{const t=m(l,a.keyTakeaways,a.keyTakeawaysEn,a.keyTakeawaysJa)||"";return ye(t)==="editorjs"?e.jsx(ge,{data:t,className:"prose dark:prose-invert max-w-none text-gray-700 dark:text-gray-300"}):e.jsx("div",{className:"prose dark:prose-invert max-w-none text-gray-700 dark:text-gray-300",dangerouslySetInnerHTML:{__html:xe(t)},onClick:r=>{const n=r.target;if(n.tagName==="BUTTON"&&n.dataset.timestamp){const v=parseInt(n.dataset.timestamp,10);B(v)}}})})()}):e.jsxs("div",{className:"text-center py-8 text-gray-500 dark:text-gray-400",children:[e.jsx("p",{className:"text-sm",children:"이 영상의 핵심 배움이 아직 기록되지 않았습니다"}),g&&e.jsx("p",{className:"text-xs mt-2",children:"위의 연필 버튼을 클릭하여 학습 기록을 추가하세요"})]})}),w&&e.jsxs("div",{children:[e.jsx(pe,{value:F,onChange:h,placeholder:"영상을 보면서 핵심 배움을 작성하세요. 리치텍스트 에디터를 사용하여 다양한 서식을 적용할 수 있습니다.",rows:8,className:"min-h-[250px]"}),e.jsxs("div",{className:"flex gap-2 mt-4",children:[e.jsxs("button",{onClick:K,disabled:u.isPending,className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors text-sm font-medium",children:[e.jsx(ie,{}),u.isPending?"저장 중...":"저장"]}),e.jsxs("button",{onClick:H,disabled:u.isPending,className:"flex items-center gap-2 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors text-sm font-medium",children:[e.jsx(ne,{}),"취소"]})]})]})]})]})]})]})}):e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Z,{className:"text-6xl text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-xl text-gray-600 dark:text-gray-400",children:"영상 학습 기록을 찾을 수 없습니다"}),e.jsx(j,{to:"/video-learnings",state:T.state,className:"text-primary-600 hover:text-primary-700 mt-4 inline-block",children:x("videoLearnings.backToList")})]})})};export{Re as default};
